# OpenStack Service Configuration

There are two ways to configure OpenStack's services.

The first and most common method is to modify Kolla-Ansible's [globals file](/openstack-kolla-globals.html).
While the options directly supported by Kolla-Ansible and its globals file are extensive, they
aren't exhaustive. Some configurations, such as Ceph's keyring files, can't be done this way.

The second approach involves writing your own configuration files. They'll be merged with those
generated by Kolla-Ansible and overwrite any values it had previously generated. The files are
expected to have particular names and exist in specific directories to function correctly. When
deploying a basic LVM cluster, no custom files need to be written.

To fine-tune the OpenStack services, create a `config/` directory.

This directory will be used with the `voithos openstack kolla-ansible` command,
specified by the `--config-dir` option.

Ceph-backed clusters should have already created some files here, as specified in the
[OpenStack Ceph setup guide](/openstack-ceph.html).


---


## config/ceilometer/polling.yaml

### Metric polling
By default ceilometer polls many metrics and doesn't poll `volume.size`. This file contains the
names of metrics of interest from arcus usage and metering perspective. `vcpus` and `memory` is
polled by nova every hour so we don't need to put it in polling.yaml.

```
# config/ceilometer/polling.yaml
---
sources:
    - name: some_pollsters
      interval: 300
      meters:
        - cpu
        - memory.usage
        - volume.size
        - compute.instance.booting.time
```


## config/ceilometer/pipeline.yaml

### Pipeline
Default archive policy used by metrics is `low`. If arcus metering will be used on this cloud,
then custom archive-policy will be used with different granularities and retention periods.
`metering-policy` will be the name of archive policy we shall create after deployment. It can be
replaced with some other name. Just use that name while creating custom archive policy after
deployment.

```
# config/ceilometer/pipeline.yaml
---
sources:
    - name: meter_source
      meters:
          - "*"
      sinks:
          - meter_sink
sinks:
    - name: meter_sink
      publishers:
          - gnocchi://?archive_policy=metering-policy
```


## config/nova/nova-compute.conf

### Resource Reservations

To prevent OpenStack from starving your hosts of resources, you should set asside some. This is
particularly important in hyperconverged deployments.

```
# config/nova/nova-compute.conf

[DEFAULT]
reserved_host_memory_mb = 16384
reserved_host_cpus = 4
reserved_host_disk_mb = 5242880
```

### Overcommit ratios

We don't suggest overcommitting RAM, else you invite the OOM killer to your environment. We find
a 5:1 CPU overcommit ratio to be safe in production.

```
# config/nova/nova-compute.conf

[DEFAULT]
cpu_allocation_ratio = 5
ram_allocation_ratio = 1
```


## config/neutron/ml2_conf.ini

### Enable VLANs

Neutron requires that the permitted VLAN range be defined on the physical provider network physnet1

```
#  config/neutron/ml2_conf.in

[ml2_type_vlan]
network_vlan_ranges = physnet1:1:4094
```


## config/keystone/keystone.conf

### Token Timeouts

Often our users upload HUGE glance images. Extending the token timeout helps with this.

```
# config/keystone/keystone.conf

[token]
expiration = 7200
```


### LDAP Configuration

Keystone can optionally use LDAP as an authentication backend. Breqwatr only supports LDAP using
Microsoft Active Directory.

- [OpenStack LDAP documentation](https://docs.openstack.org/keystone/pike/admin/identity-integrate-with-ldap.html)
- [Keystone config reference](https://docs.openstack.org/ocata/config-reference/identity/samples/keystone.conf.html)
- [Kolla-Ansible's keystone.conf Jinja2 template](https://github.com/openstack/kolla-ansible/blob/master/ansible/roles/keystone/templates/keystone.conf.j2)

By creating the domains directory, Kolla-Ansible's Jinja2 tempalte will automatically enable
`domain_specific_drivers_enabled`, so it doesn't need to set. The `[identity] driver` key still
needs to be defined.


## Keystone Domain-specific path: config/keystone/domains/keystone.DOMAIN\_NAME.conf

### Domain Creation

In the OpenStack cli, create the domain

```bash
openstack domain create <name>
```

### Domain Configuration

When using LDAP with Keystone, each domain's data should be configured in its own file.

Where the target domain to be "example.com", you would create a file named
`config/keystone/domains/keystone.example.com.conf` to define the domain details.


```ini
# config/keystone/domains/keystone.DOMAIN_NAME.conf

[identity]
driver = ldap


[ldap]

# Multiple LDAP URLs may be specified as a comma separated string
url = ldap://localhost

# Service account credentials
user = dc=Manager,dc=example,dc=org
password = samplepassword

# The default LDAP server suffix to use, if a DN is not defined via either
suffix = dc=example,dc=org

# Define the search trees for LDAP
user_tree_dn = ou=Users,dc=example,dc=org
group_tree_dn = ou=Groups,dc=example,dc=org

# Use a group to determine which users have access
user_filter = (memberOf=cn=grp-openstack,CN=Users,DC=ad,DC=local)

# Active Directory uses the following object classes & attributes
user_objectclass = person
group_objectclass = group
user_name_attribute = sAMAccountName
user_id_attribute = cn
user_mail_attribute = mail
user_pass_attribute = userPassword
user_enabled_attribute = userAccountControl
user_enabled_mask = 2
user_enabled_invert = false
user_enabled_default = 512
group_id_attribute = cn
group_name_attribute = ou
group_member_attribut = member
group_desc_attribute = description

# debug levels of 0,255, and 4095 are common, with 4095 the most verbose
debug_level = 0
```

